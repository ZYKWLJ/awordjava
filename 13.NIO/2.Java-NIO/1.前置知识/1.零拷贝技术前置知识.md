# 零拷贝——减少内存到内存的拷贝
(IO 就是一块内存的抽象)

## 一、概述：
零拷贝（Zero-copy）是一种优化技术，并不是一次拷贝都不做，而是**旨在减少数据在系统内部的复制操作**，从而**提高数据传输的效率**。它的主要目标是**减少内存到内存**之间的数据拷贝。 

## 二、两种实现方式
零拷贝有两种实现方式： 
1. MMap 

2. SendFile

## 三、MMap ——减少一次读取复制
![alt text](../img/零拷贝技术-MMap.png)

### (一)MMAP本质：
本质：mmap（内存映射）是一种内存管理技术，它允许**将一个文件或者其他对象映射到进程的地址空间中**，实现文件**磁盘地址和进程虚拟地址空间**中一段虚拟地址的**一一对应关系**。这样进程可以直接访问磁盘的地址。


通过上文我们知道**一次IO，数据会进行四次拷贝**，MMap这种方式在将**内核段中的数据拷贝到用户段的这次拷贝中拷贝的不是数据，而是数据的映射(虚拟地址)**，直接让**用户空间的虚拟地址与内核空间中数据所在的物理地址区域**建立联系，数据不需要从内核缓冲区拷贝到用户缓冲区 （即少了上述的第二次拷贝），从而减少了一次拷贝。

### (三)OS底层的两种读取方式

之所以能实现这样的效果是得益于操作系统底层有两种读操作： 

#### 1. 读取数据：

常见的系统调用如 read()（用于文件描述符）或 recv()（用于套接字）用于从文件或套接字中读取数据。这些系统调用从相应的输入源（如磁盘、网络等）读取数据，并**将其复制到应用程序提供的缓冲区中**。这种方式涉及了数据的复制，因为数据需要**从内核态复制到用户态缓冲区中**。 

#### 2.  读取映射：

另一种方式是通过内存映射（Memory Mapping）来实现读取操作。**通过将文件或设备的数据映射到进程的内存区域中，应用程序可以直接访问内存映射区域中的数据**，而无需使用传统的 read() 系统调用。在这种情况下，应用程序可以通过直接读取内存映射区域中的数据来获取文件或设备的内容，**避免了中间的数据复制**。


---
## 四、SendFile ——只读取不修改，一般是网络传输！
![alt text](../img/零拷贝技术-sendfile，只传输不修改.png)

SendFile更狠，**直接就不走用户段**，直接就是**从内核段的一个内存地址复制到另一个内存地址**，主要是拿来进行网络传输的，从本地磁盘读数据，读到一个地址里，然后将这个地址里的数据复制给另一个IO设备的地址，这个地址就可以是网络IO的地址。很明显sendFile有一个弊病，**就是没走用户段的话，数据没办法处理**，所以其只是一种用于**实现数据传输的 "零拷贝" 技术**，而**不能直接进行数据处理**。并且SendFile还存在大小限制。

