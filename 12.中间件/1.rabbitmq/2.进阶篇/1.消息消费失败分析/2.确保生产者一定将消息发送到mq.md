# 背景
在 RabbitMQ 中，生产者将消息发送到 MQ 时，默认情况下**并不知道消息是否成功到达 MQ** 或者**是否被正确路由到队列**。确认机制的引入就是为了**让生产者能够知晓消息的处理状态**，从而可以根据不同的状态采取相应的措施，比如**重试发送、记录日志等，以保证消息的可靠传递**。


## 解决方案核心来源
根据**TCP的可靠性连接**的原理来完成mq的的消息可靠性传输！


## 一、生产者消息重试机制=>重传机制！

 当网络突然断开后，与mq失联，**生产者可以尝试重新发送**。一般对**业务性能高**的建议少用，
 因为SpringAMQP的是重试机制的**当前线程是阻塞的**，会带满整个系统

## 二、生产者的消息确认机制=>ACK

 在开启确认机制的情况下，当生产者发送消息给MQ后，MQ会根据消息处理的情况**返回不同的回执**


---
### 1.Publisher Return

### 触发场景：
当消息投递到了 MQ 中，但是 MQ **没有将消息路由到任何队列时**，就会触发 Publisher Return 机制。
这种情况通常发生在**使用了交换机（如直连交换机、主题交换机**），并且**指定的路由键没有匹配到任何绑定的队列时**。



### 回执信息:
当触发 Publisher Return 时，MQ 会返回 return 信息，其中**包含异常信息和 ack**。
ack 表示消息已经到达了 MQ，但是**由于路由问题没有被分发到队列**。异常信息会详细说明路由失败的原因，帮助生产者定位问题


---
### 2.Publisher Confirm
   
   临时消息入队成功，返回ack，告知投递成功
   
   持久化消息入队成功并持久化，返回ack，告知投递成功,并且持久化到磁盘了！
   
   其它情况都会**返回NACK，告知投递失败**，一般有重试机会，失败后被认定为异常

---
### 异常处理

当生产者收到 NACK 时，一般会有重试机会。生产者可以在收到 NACK 后，重新发送消息，**直到达到最大重试次数**。如果多次重试仍然失败，那么就会被**认定为异常**，此时可以采取**记录日志、通知管理员**等措施。



---
# Return和Confirm的区别

Publisher Return 重点在于反馈**消息在路由过程中出现的错误信息**，前提是**消息已经到达了 RabbitMQ 服务器**。

Publisher Confirm 更侧重于**确认消息整体的处理结果**，既会**返回成功的确认信息（ACK），也会返回失败的确认信息（NACK）**。