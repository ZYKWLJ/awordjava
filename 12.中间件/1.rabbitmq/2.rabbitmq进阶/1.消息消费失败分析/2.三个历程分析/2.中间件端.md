
# 一、问题：
## 1.宕机丢失数据
 mq中的所有消息**都是放在内存中的，重启后就没了** 这样就会导致消息丢失。这对于一些需要保证消息可靠性的业务场景来说是不可接受的，比如订单处理、金融交易等场景。

## 2.内存不足时页面调出
 其次当**内存不足时，会将其临时存储在磁盘里**，这个过程叫做**pageOut。是阻塞的<页面调出！>**，极大**降低了这个段时间的性能**。

---
# 二、解决：
## (一)实现数据持久化——创建队列与交换机时，就设置持久化参数！

### 1.mq3.6之前

在创建交换机时，需要将**交换机、队列等的 durable 参数设置为 true**，这样交换机就会在 MQ 重启后依然存在，不会丢失相关配置。

配置创建的交换机持久化

配置创建的queue持久化

配置消息存储的持久化

#### 1.批量写入——(减少IO)

#### 2.异步写入——(防止pageOut阻塞)

---
### 2.mq3.6之后官方默认——lazyqueue实现惰性队列

#### 1.直接存入磁盘——防止丢失

接受后的**消息直接存入磁盘，而非内存**

#### 2.需要时再拿出来——(减少IO)

要消费消息时，**才将消息加载进内存（懒加载）**

#### 3.SSD等磁盘优化
底层优化，支持**数百万条消息的存储**